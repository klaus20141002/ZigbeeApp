window.ThinkPage=window.ThinkPage||{};window.ThinkPage.Weather=window.ThinkPage.Weather||{};var forceImplicitSelector=forceImplicitSelector||false;window.ThinkPage.Weather.API=(function(){var isLoading=false;$.ajaxSetup({contentType:"application/json; charset=utf-8",dataType:"json"});return{GetWeather:function(cityId,callback,context){if(!isLoading){$(window).trigger("THINKPAGE_WEATHER_REQUEST",cityId);var req=thinkpage_weather_req;req["CityId"]=cityId;req["CityName"]=null;isLoading=true;$.ajax({type:"GET",url:"/weather/api.svc/getWeather",data:{city:req["CityId"],language:req["Language"],provider:req["Provider"],unit:req["Unit"],aqi:'city'},success:function(result){isLoading=false;callback.call(context,result)}})}},SearchCity:function(keyword,callback,context){if(!isLoading){var req=thinkpage_weather_req;isLoading=true;$.ajax({type:"GET",url:"/weather/WeatherService.svc/GetLocationsByKeyword",data:{keyword:keyword,lang:req["Language"],provider:req["Provider"]},success:function(result){isLoading=false;setTimeout(function(){callback.call(context,result)},0)}})}},GetChildLocations:function(id,plevel,callback,context){if(!isLoading){var req=thinkpage_weather_req;isLoading=true;$.ajax({type:"GET",url:"/weather/WeatherService.svc/GetChildLocations",data:{id:id,lang:req["Language"],provider:req["Provider"]},success:function(result){isLoading=false;callback.call(context,{"plevel":plevel,"list":result})}})}},GetParentLocationPath:function(id,callback,context){if(!isLoading){var req=thinkpage_weather_req;isLoading=true;$.ajax({type:"GET",url:"/weather/WeatherService.svc/GetParentLocationPath",data:{id:id,lang:req["Language"],provider:req["Provider"]},success:function(result){isLoading=false;callback.call(context,result)}})}}}})();window.ThinkPage.Weather.Common=(function(){return{GetIcon:function(type,code,time){var p=$("span[id$='"+type+"']").text()||type;if(p.match(/{QQ}/ig)!=null){var q=["lrain","lrain","lrain","lrain","lrain","rs","rs","rs","rs","srain","mrain","brain","drain","ssnow","bsnow","sand","msnow","lrain","rs","fog","fog","fog","fog","sand","sand","shade","shade","night","cloud","night","cloud","3","sun","night","cloud","lrain","sun","lrain","lrain","srain","drain","ssnow","bsnow","bsnow","sun","srain","ssnow","lrain"];return p.replace("{QQ}",q[code])}else if(p.match(/{YAHOO}/ig)!=null){var h=new Date(time.replace(/-/ig,"/")).getHours();var suffix="";if(h>5&&h<19)suffix="d";else suffix="n";return p.replace("{YAHOO}",code+suffix)}else{return p.replace("{CODE}",code)}}}})();window.ThinkPage.Weather.Widget=(function(){function getAQILevelByIndex(index){if(index<=50)return 0;else if(index<=100)return 1;else if(index<=150)return 2;else if(index<=200)return 3;else if(index<=300)return 4;else return 5}var Weather=function(){var that=this;var req;$(document).ajaxStart(function(evt,xhr,opts){$("#tp-weather-widget #loading").fadeIn()});$(document).ajaxStop(function(evt,xhr,opts){$("#tp-weather-widget #loading").fadeOut()});$(document).ajaxComplete(function(evt,xhr,opts){});$(document).ajaxError(function(evt,xhr,opts,ex){$("div[id$='weatherAJAX']").html("Error: "+ex)});this.onGetChildLocations=function(result){var plevel=result["plevel"];var list=result["list"];$("select[id$='ddlL"+plevel+"']").empty();$.each(list,function(i,val){$("select[id$='ddlL"+plevel+"']")[0].options.add(new Option(val["value"],val["key"]))});if(plevel==2){ThinkPage.Weather.API.GetChildLocations($("select[id$='ddlL"+plevel+"']").val(),plevel+1,that.onGetChildLocations,that)}else if(plevel==3){ThinkPage.Weather.API.GetWeather($("select[id$='ddlL"+plevel+"']").val(),that.Render,that)}};this.ToggleAD=function(closeAD){if($("#divAD")){if($("#divAD").css("display")!="none"||closeAD){$("#divAD").hide();if($("#spanDate")){$("#spanDate").show()}}else{$("#divAD").show();if($("#spanDate")){$("#spanDate").hide()}}}};function showAirQuality(airQuality){if(airQuality){$('#air-quality-level').text(airQuality.CityInfo.Quality).removeClass().addClass("air-quality-value aqi-level-"+getAQILevelByIndex(airQuality.CityInfo.AQI));$('#air-quality-aqi').text(airQuality.CityInfo.AQI);$('#air-quality-pm25').text(airQuality.CityInfo.PM25);$('#air-quality-pm10').text(airQuality.CityInfo.PM10);$('#air-quality-co').text(airQuality.CityInfo.CO);$('#air-quality-no2').text(airQuality.CityInfo.NO2);$('#air-quality-o3').text(airQuality.CityInfo.O3);$('#air-quality-so2').text(airQuality.CityInfo.SO2);if(typeof thinkpage_weather_air_info!="undefined"){$("#air-impacts .value").text(thinkpage_weather_air_info[getAQILevelByIndex(airQuality.CityInfo.AQI)]["impact"]);$("#air-suggestions .value").text(thinkpage_weather_air_info[getAQILevelByIndex(airQuality.CityInfo.AQI)]["suggestion"])}}else{$('.air-quality-value').text("-").removeClass().addClass("air-quality-value");$("#air-impacts .value").text("-");$("#air-suggestions .value").text("-")}};this.Render=function(res){thinkpage_weather_res=res;$(window).trigger("THINKPAGE_WEATHER_RESPONSE",res);var weather=thinkpage_weather_res["Weathers"][0];showAirQuality(weather.AirQuality);$(".linkCity").attr("href","http://www.thinkpage.cn/weather/?cid="+weather["CityId"]);if(thinkpage_weather_vip){$(".linkBody").css("cursor","pointer").unbind().click(function(){_hmt.push(['_trackEvent','Widget','Widget Event','Widget Click TP']);window.open("http://www.thinkpage.cn/weather/?cid="+weather["CityId"]);return false});bindTempUnitEvent()}else{$("html").hover(function(){_hmt.push(['_trackEvent','Widget','Widget Event','Widget Show AD']);$("#divAD").show().css("cursor","pointer").unbind().click(function(){_hmt.push(['_trackEvent','Widget','Widget Event','Widget Click AD']);window.open("http://www.coolgy.com");return false})},function(){$("#divAD").hide().unbind()})};$("span[id$='ltlCity']").text(req["CityName"]?req["CityName"]:weather["CityName"]);$(".currentIcon").attr({"src":ThinkPage.Weather.Common.GetIcon("cip",weather["Current"]["Code"],weather["LastBuildDate"])});$("span[id$='ltlText']").text(weather["Current"]["Text"]);$("span[id$='ltlTemperature'] .temp").text(weather["Current"]["Temperature"]);$("span[id$='ltlFeel'] .temp").text(getFeel(weather["Current"]["Temperature"],weather["Current"]["Speed"]));if(req["Language"].toLowerCase()=="en"){$("span[id$='ltlSpeed'] .value").text(weather["Current"]["Direction"]+" "+weather["Current"]["Speed"])}else{$("span[id$='ltlSpeed'] .value").text(weather["Current"]["Direction"]+((req["Language"].toLowerCase()=="zh-cht")?"風":"风")+getWindPower(weather["Current"]["Speed"]))};$("span[id$='ltlSpeed']").attr("title",weather["Current"]["Speed"]+"km/h");if(weather["AirQuality"]){$("span[id$='ltlAirQuality']").attr("title","AQI: "+weather["AirQuality"]["CityInfo"]["AQI"]+"\r\n"+"PM2.5: "+weather["AirQuality"]["CityInfo"]["PM25"]+" μg/m³\r\n"+"PM10: "+weather["AirQuality"]["CityInfo"]["PM10"]+" μg/m³\r\n"+"CO: "+weather["AirQuality"]["CityInfo"]["CO"]+" mg/m³\r\n"+"NO2: "+weather["AirQuality"]["CityInfo"]["NO2"]+" μg/m³\r\n"+"O3: "+weather["AirQuality"]["CityInfo"]["O3"]+" μg/m³\r\n"+"SO2: "+weather["AirQuality"]["CityInfo"]["SO2"]+" μg/m³")}else{$("span[id$='ltlAirQuality']").removeAttr("title")};$("span[id$='ltlVisibility'] .value").text(weather["Current"]["Visibility"]);$("span[id$='ltlSunrise'] .value").text(weather["Current"]["Sunrise"]);$("span[id$='ltlSunset'] .value").text(weather["Current"]["Sunset"]);$("span[id$='ltlHumidity'] .value").text(weather["Current"]["Humidity"]);$("span[id$='ltlPressure'] .value").text(weather["Current"]["Pressure"]);$("span[id$='ltlTime']").text(new Date(weather["LastBuildDate"]).toLocaleTimeString());$(".unit").text(req["Unit"]);var days=req["ForecastDays"]<weather["Forecast"].length?req["ForecastDays"]:weather["Forecast"].length;$("div[id$='divForecastWeather'] .forecast:not(:first)").remove();var day=$("div[id$='divForecastWeather'] .forecast:first");var setting_display_as_original=$("span[id$='setting_display_as_original']").length!=0;var setting_forecastDay_as_date=$("span[id$='setting_forecastDay_as_date']").length!=0;var setting_forecastDay=$("span[id$='setting_forecastDay']").length==0?[]:$("span[id$='setting_forecastDay']").text().split('|');for(var i=0;i<days;i++){$(day).find(".forecastDay").html((i==0&&!setting_display_as_original&&!req["DisplayCurrent"])?"<span class=\"cityName\">"+weather["CityName"]+"</span>":setting_forecastDay.length!=0?setting_forecastDay[i]:setting_forecastDay_as_date?new Date(parseInt(weather["Forecast"][i]["Date"].substr(6))).getMonth()+1+"/"+new Date(parseInt(weather["Forecast"][i]["Date"].substr(6))).getDate():weather["Forecast"][i]["Day"]);$(day).find(".forecastIcon").attr({"src":ThinkPage.Weather.Common.GetIcon("fip",weather["Forecast"][i]["Code"],weather["LastBuildDate"]),"title":weather["Forecast"][i]["Text"],"alt":weather["Forecast"][i]["Text"]});$(day).find(".forecastText").text(weather["Forecast"][i]["Text"]||"-");$(day).find(".forecastCop").text(weather["Forecast"][i]["Cop"]||"");$(day).find(".high").text(weather["Forecast"][i]["High"]||"");$(day).find(".low").text(weather["Forecast"][i]["Low"]||"");if(i<(days-1)){var newday=$(day).clone();$(day).after(newday);day=newday}};bindTempUnitEvent();appendChangeCity();setRecent(req["CityId"])};var convertTempUnit=function(value,unit){return Math.round(unit=="F"?value*9/5+32:(value-32)*5/9)};var getWindPower=function(kmh){if(isNaN(kmh))return"";return Math.round(Math.pow(kmh/(3.6*0.836),2/3))};var getFeel=function(temp,wind){if(isNaN(wind)){return temp};if(req["Unit"]=="F"){temp=convertTempUnit(temp,"C")};var wc=(13.12+0.6215*temp-11.37*Math.pow(wind,0.16)+0.3965*temp*Math.pow(wind,0.16));if(req["Unit"]=="F"){wc=convertTempUnit(wc,"F")};return Math.round(wc)};var toggleTempUnit=function(){req["Unit"]=req["Unit"]=="C"?"F":"C";$(".temp").each(function(){$(this).text(convertTempUnit(parseFloat($(this).text()),req["Unit"]))});$(".unit").each(function(){$(this).text(req["Unit"])})};var bindTempUnitEvent=function(){$(".temp").css("cursor","pointer").click(toggleTempUnit)};var unbindTempUnitEvent=function(){$(".temp").css("cursor","").unbind()};var appendChangeCity=function(){if(req["DisplayCitySelect"]==2||forceImplicitSelector){$("#changeCity").remove();if($(".cityName").parent().is("a")){$(".cityName").parent().before("<img id=\"changeCity\" src=\"/weather/images/select.gif\"/>")}else{$(".cityName").before("<img id=\"changeCity\" src=\"/weather/images/select.gif\"/>")};$("#changeCity").click(function(){$("#divOverlay").show();$("#divSelector").show();return false})}};var setRecent=function(cityId){var recent=$.cookie("thinkpage_weather_recent")?$.cookie("thinkpage_weather_recent").split(','):[];recent=$.grep(recent,function(a){return(a!=cityId)});recent.push(cityId);recent=recent.reverse();if(recent.length>5)recent.length=5;recent=recent.reverse();$.cookie("thinkpage_weather_recent",recent.join(','),{expires:3650})};this.Init=function(){req=thinkpage_weather_req;if(thinkpage_weather_res!=null){ThinkPage.Weather.Widget.Render(thinkpage_weather_res)}else{ThinkPage.Weather.API.GetWeather(null,function(weather){ThinkPage.Weather.Widget.Render(weather)})};var adtimer;if(req["DisplayCitySelect"]==2||forceImplicitSelector){$("#divSelector").addClass("implicitSelect");$("#btnConfirm").show()}if(req["LinksType"]==0){$("a.linkCity").each(function(i,l){$(l).replaceWith($(l).html())})};$(".linkCity:has(img)").click(function(){_hmt.push(['_trackEvent','Widget','Widget Event','Widget Click Image'])});$('.linkCity:not(:has(img))').click(function(){_hmt.push(['_trackEvent','Widget','Widget Event','Widget Click Text'])});if($("#txtSearch").size()!=0){$("#txtSearch").css("color","#C6C6C6").val(tp_weather_widget_search_tip).keydown(function(event){if(event.keyCode==13){ThinkPage.Weather.Selector.DoSearch($(this).val());return false}}).focus(function(event){if($(this).val()==tp_weather_widget_search_tip){$(this).css("color","#000000").val("")}}).blur(function(event){if($(this).val()==""){$(this).css("color","#C6C6C6").val(tp_weather_widget_search_tip)}});$("#btnToggle").click(function(event){$("#divSelectCity").toggle();$("#divSearchCity").toggle()});$("#btnConfirm").click(function(){if($("#txtSearch").val()!=tp_weather_widget_search_tip){ThinkPage.Weather.Selector.DoSearch($("#txtSearch").val())}$("#divOverlay").fadeOut("fast");$("#divSelector").fadeOut("fast")})};}};return new Weather()})();window.ThinkPage.Weather.Selector=(function(){var onSearchCity=function(result){if(result.length!=0){ThinkPage.Weather.API.GetWeather(result[0]["Id"],function(weather){ThinkPage.Weather.Widget.Render(weather)})}};return{DoSearch:function(keyword){if($("#txtSearch").val()!=""){ThinkPage.Weather.API.SearchCity(keyword,onSearchCity)}}}})();$(function(){if($("#tp-weather-widget").size()!=0){ThinkPage.Weather.Widget.Init()}});jQuery.cookie=function(name,value,options){if(typeof value!='undefined'){options=options||{};if(value===null){value='';options.expires=-1};var expires='';if(options.expires&&(typeof options.expires=='number'||options.expires.toUTCString)){var date;if(typeof options.expires=='number'){date=new Date();date.setTime(date.getTime()+(options.expires*24*60*60*1000))}else{date=options.expires}expires='; expires='+date.toUTCString()};var path=options.path?'; path='+(options.path):'';var domain=options.domain?'; domain='+(options.domain):'';var secure=options.secure?'; secure':'';document.cookie=[name,'=',encodeURIComponent(value),expires,path,domain,secure].join('')}else{var cookieValue=null;if(document.cookie&&document.cookie!=''){var cookies=document.cookie.split(';');for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}};return cookieValue}};